<?phpinclude_once 'app/moduli/menu_amm/operazioni/oggetti/OperazioneDefault.php';class bandigara extends OperazioneDefault {		var $correttoValoreBaseAsta = array();		public function __construct() { }		public function preInsert($arrayParametri = array()) {		global $enteAdmin;				//questa condizione con il relativo codice interno deve stare prima delle chiamate a correggiValori e caricaValoriProceduraRelativa		if(moduloAttivo('bandigara')) {			$this->preparaValoriCigMultipli();		}		$this->correggiValori();		$this->caricaValoriProceduraRelativa();				if(moduloAttivo('stazioni_appaltanti')) {			$this->impostaStazioneAppaltante();		}		//lognormale('',$this->correttoValoreBaseAsta);	}		public function preUpdate($arrayParametri = array()) {		global $enteAdmin;		$this->correggiValori();		$this->caricaValoriProceduraRelativa();				if(moduloAttivo('stazioni_appaltanti')) {			$this->impostaStazioneAppaltante();		}	}		public function preDelete() {		if(moduloAttivo('bandigara')) {			$this->verificaEliminazioneLotti();		}	}		public function postInsert($arrayParametri = array()) {		global $database, $dati_db, $enteAdmin,$datiUser,$idEnte,$configurazione,$entePubblicato;				if(moduloAttivo('ealbo')) {			$this->inserisciRecordAtto();		}		if(moduloAttivo('bandigara')) {			$this->inserisciRecordAltriCig();						$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." AND id_proprietario = ".$datiUser['id']." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$istanzaOggetto = $database->sqlArray($result);			$this->verificaErroriAnac($istanzaOggetto);		}		if(moduloAttivo('bandigara') and moduloAttivo('agid') and $_POST['tipologia'] == 'affidamenti' and $_POST['cig'] != '' and $_POST['cig'] != '0000000000' and $idEnte == 150) {			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." AND id_proprietario = ".$datiUser['id']." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$istanzaOggetto = $database->sqlArray($result);			//include_once('codicepers/config/150/aggancia_liquidazioni.php');		}	}		public function postUpdate($arrayParametri = array()) {		global $database, $dati_db, $enteAdmin,$datiUser,$idEnte,$configurazione,$entePubblicato;				if(moduloAttivo('bandigara')) {			$istanzaOggetto = mostraDatoOggetto(forzaNumero($_GET['id']), 11, '*');			$this->verificaErroriAnac($istanzaOggetto);						//disabilito la chiamata a $this->modificaRecordAltriCig(); - Dal 03/07/2019 il lotto ha un oggetto.			//$this->modificaRecordAltriCig();		}				if(moduloAttivo('bandigara') and moduloAttivo('agid') and $_POST['tipologia'] == 'affidamenti' and $_POST['cig'] != '' and $_POST['cig'] != '0000000000' and $idEnte == 150) {		    $istanzaOggetto = mostraDatoOggetto(forzaNumero($_GET['id']), 11, '*');			//include_once('codicepers/config/150/aggancia_liquidazioni.php');		}			}		public function postImport($arrayParametri = array()) {		global $database, $dati_db;				if(moduloAttivo('bandigara')) {			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".forzaNumero($_POST['id_ente'])." AND id_proprietario = ".forzaNumero($_POST['utente'])." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$istanzaOggetto = $database->sqlArray($result);			$this->verificaErroriAnac($istanzaOggetto);		}	}		public function postDelete($arrayParametri = array()) {		if(moduloAttivo('ealbo')) {			$this->eliminaRecordAtto();		}		if(moduloAttivo('bandigara')) {			$this->eliminazioneLottiOrfani();		}	}		private function inserisciRecordAtto() {		global $database, $dati_db, $enteAdmin;				$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." ORDER BY id DESC LIMIT 1";		if(!($result = $database->connessioneConReturn($sql))) {}		$record = $database->sqlArray($result);				$atto = caricaDocumentoEAlbo('atti', forzaNumero($_POST['id_atto_albo']));				$sql = "INSERT INTO ".$dati_db['prefisso']."etrasp_atti_ealbo (id_ente, id_ente_albo, id_atto_albo, id_oggetto, id_documento, ultima_modifica) 				VALUES (".$enteAdmin['id'].", ".$enteAdmin['id_ente_albo'].", ".forzaNumero($_POST['id_atto_albo']).", 11, ".$record['id'].", ".$atto['ultima_modifica'].")";		if(!($result = $database->connessioneConReturn($sql))) {}				collegaAttoEtrasparenza(forzaNumero($_POST['id_atto_albo']), 1, $enteAdmin);	}		private function eliminaRecordAtto() {		global $database, $dati_db, $enteAdmin;				$cancello = isset($_POST['id_cancello_tabella']) ? forzaStringa($_POST['id_cancello_tabella']) : 0;		$arrayOggetti = explode(",", $cancello);		$arrayOggettiAlbo = array();		$numeroOggetti = count($arrayOggetti)-1;		$condizione = 'id_documento='.$arrayOggetti[0];		$arrayOggettiAlbo[] = getIdRecordAtto($enteAdmin['id'], $enteAdmin['id_ente_albo'], $arrayOggetti[0], 11);		for ($i=1;$i<$numeroOggetti+1;$i++) {			if ($arrayOggetti[$i] != '') {				$condizione .= ' OR id_documento='.$arrayOggetti[$i];				$arrayOggettiAlbo[] = getIdRecordAtto($enteAdmin['id'], $enteAdmin['id_ente_albo'], $arrayOggetti[$i], 11);			}		}		$sql = "DELETE FROM ".$dati_db['prefisso']."etrasp_atti_ealbo WHERE id_ente = ".$enteAdmin['id']." AND id_ente_albo = ".$enteAdmin['id_ente_albo']." AND id_oggetto = 11 AND (".$condizione.")";		if(!($result = $database->connessioneConReturn($sql))) {}				foreach((array) $arrayOggettiAlbo as $id) {			collegaAttoEtrasparenza($id, 0, $enteAdmin);		}	}		private function preparaValoriCigMultipli() {		//metodo richiamato se modulo 'bandigara' e' attivo		if($_POST['tipologia'] == 'bandi ed inviti') {					$_POST['altri_cig'] = array();			for($i=1; $i<=$_POST['numRigheCig']; $i++) {				if(trim($_POST['cig'.$i]) != '' or trim($_POST['valore_base_asta'.$i]) != '') {					$this->correggiValori($i);					$_POST['altri_cig'][] = array (						'cig' => forzaStringa($_POST['cig'.$i]),						'valore_base_asta' => forzaStringa($_POST['valore_base_asta'.$i])					);				}			}						if(count($_POST['altri_cig']) > 1) {				//il bando principale non avrÃ  cig, nÃ¨ valori. Il valore importo a base asta sarÃ  la somma di tutti i singoli valori				$_POST['cig'] = '';				$_POST['valore_base_asta'] = '';			} else if(count($_POST['altri_cig']) == 1) {				//inserimento bando con cig singolo ( il valore_base_asta e' stato gia' corretto? si, impostarlo come corretto in $this->correttoValoreBaseAsta['valore_base_asta'])			    $_POST['cig'] = forzaStringa($_POST['altri_cig'][0]['cig']);			    $_POST['valore_base_asta'] = forzaStringa($_POST['altri_cig'][0]['valore_base_asta']);				$this->correttoValoreBaseAsta['valore_base_asta'] = true;	//non eliminare			}		} else if($_POST['tipologia'] == 'lotto') {			$_POST['oggetto'] = addslashes(mostraDatoOggetto(forzaNumero($_POST['id_record_cig_principale']), 11, 'oggetto'));		}	}		private function inserisciRecordAltriCig() {		global $database, $dati_db, $enteAdmin, $oggOgg, $idCategoriaPasso;				if(count($_POST['altri_cig']) > 1) {			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$record = $database->sqlArray($result);						$aggiorno = false;			foreach((array)$_POST['altri_cig'] as $recordCig) {				$arrayLotto = array();				$arrayLotto['id_lingua'] = '0';				$arrayLotto['id_proprietari_admin'] = '-1';				$arrayLotto['tipo_proprietari_admin'] = 'tutti';				$arrayLotto['permessi_admin'] = 'N/A';				$arrayLotto['id_proprietari_lettura'] = '-1';				$arrayLotto['tipo_proprietari_lettura'] = 'tutti';				$arrayLotto['permessi_lettura'] = 'N/A';				$arrayLotto['id_proprietario'] = forzaNumero($_POST['id_proprietario']);				$arrayLotto['id_ente'] = $enteAdmin['id'];								$arrayLotto['scelta_contraente'] = forzaStringa($_POST['scelta_contraente']);				$arrayLotto['denominazione_aggiudicatrice'] = forzaStringa($_POST['denominazione_aggiudicatrice']);				$arrayLotto['dati_aggiudicatrice'] = forzaStringa($_POST['dati_aggiudicatrice']);								$arrayLotto['data_attivazione'] = forzaNumero($_POST['data_attivazione']);				$arrayLotto['oggetto'] = forzaStringa($_POST['oggetto']);				$arrayLotto['tipologia'] = 'lotto';				$arrayLotto['cig'] = $recordCig['cig'];				$arrayLotto['valore_base_asta'] = $recordCig['valore_base_asta'];				$arrayLotto['id_record_cig_principale'] = $record['id'];				$arrayLotto['stato_pubblicazione'] = ($_POST['stato_pubblicazione'] ? forzaNumero($_POST['stato_pubblicazione']) : '100');				$oggOgg->aggiungiOggetto($idCategoriaPasso, $arrayLotto);				$aggiorno = true;			}			if($aggiorno) {				//NOTA: non permettere la trasformazione da lotto singolo a multilotto				//ho piÃ¹ lotti per la stessa procedura				$sql = "UPDATE ".$dati_db['prefisso']."oggetto_gare_atti SET id_record_cig_principale = ".$record['id']." WHERE id = ".$record['id'];				if(!($result = $database->connessioneConReturn($sql))) {}			}		}	}		private function modificaRecordAltriCig() {		global $database, $dati_db, $enteAdmin, $oggOgg, $idCategoriaPasso;			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." AND id_record_cig_principale = ".forzaNumero($_GET['id'])." AND tipologia = 'lotto'";		if(!($result = $database->connessioneConReturn($sql))) {}		$lotti = $database->sqlArrayAss($result);						foreach((array)$lotti as $lotto) {			$oggetto = addslashes(forzaStringa($_POST['oggetto']));			$sql = "UPDATE ".$dati_db['prefisso']."oggetto_gare_atti SET oggetto = '".$oggetto."' WHERE id = ".$lotto['id'];			if(!($result = $database->connessioneConReturn($sql))) {}		}	}		private function correggiValori($suffisso = '') {		//if(count($_POST['altri_cig']) > 0) {		//if($suffisso > 0 or $_GET['id']>0) {		if(!$this->correttoValoreBaseAsta['valore_base_asta'.$suffisso]) {			//correggo una sola volta in caso di singolo bando. Perchè? Perchè già l'ho fatto girare. NON MODIFICARE			//lognormale('qua pre suffisso = '.$suffisso,$_POST['valore_base_asta'.$suffisso]);			if(trim($_POST['valore_base_asta'.$suffisso]) != '') {				$_POST['valore_base_asta'.$suffisso] = str_replace(',','.',str_replace('.','',trim(forzaStringa($_POST['valore_base_asta'.$suffisso]))));			}			//lognormale('qua post suffisso = '.$suffisso,$_POST['valore_base_asta'.$suffisso]);			$this->correttoValoreBaseAsta['valore_base_asta'.$suffisso] = true;		}		if(trim($_POST['valore_importo_aggiudicazione'.$suffisso]) != '') {		    $_POST['valore_importo_aggiudicazione'.$suffisso] = str_replace(',','.',str_replace('.','',trim(forzaStringa($_POST['valore_importo_aggiudicazione'.$suffisso]))));		}		if(trim($_POST['importo_liquidato'.$suffisso]) != '') {		    $_POST['importo_liquidato'.$suffisso] = str_replace(',','.',str_replace('.','',trim(forzaStringa($_POST['importo_liquidato'.$suffisso]))));		}	}		private function impostaStazioneAppaltante() {		global $database, $dati_db, $enteAdmin;				if($_POST['bando_collegato']){			$id_bando_collegato = forzaNumero($_POST['bando_collegato']);			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." AND id=".$id_bando_collegato." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$record = $database->sqlArray($result);			if($record['id_stazione']){				$_POST['id_stazione'] = $record['id_stazione'];			}		}	}		private function caricaValoriProceduraRelativa() {		global $database, $dati_db, $enteAdmin;				if($_POST['bando_collegato']){			$id_bando_collegato = forzaNumero($_POST['bando_collegato']);			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." AND id=".$id_bando_collegato." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$record = $database->sqlArray($result);			if($record['cig']){				$_POST['cig'] = $record['cig'];				if($_POST['tipologia'] == 'somme liquidate' and moduloAttivo('bandigara')) {					//$_POST['oggetto'] = addslashes($record['oggetto']);					$_POST['struttura'] = $record['struttura'];				} 			}			if($_POST['tipologia'] == 'esiti' and moduloAttivo('bandigara')) {				if($record['tipologia'] == 'lotto'){					$record = mostraDatoOggetto($record['id_record_cig_principale'], 11, '*');				}				$_POST['scelta_contraente'] = addslashes($record['scelta_contraente']);				$_POST['denominazione_aggiudicatrice'] = addslashes($record['denominazione_aggiudicatrice']);				$_POST['dati_aggiudicatrice'] = addslashes($record['dati_aggiudicatrice']);				$_POST['tipo_amministrazione'] = addslashes($record['tipo_amministrazione']);				$_POST['sede_provincia'] = addslashes($record['sede_provincia']);				$_POST['sede_comune'] = addslashes($record['sede_comune']);				$_POST['sede_indirizzo'] = addslashes($record['sede_indirizzo']);				$_POST['struttura'] = $record['struttura'];				$_POST['anac_anno'] = $record['anac_anno'];			}		}			}		private function verificaEliminazioneLotti() {		global $database, $dati_db, $enteAdmin;				$lotti = array();		$cancello = isset($_POST['id_cancello_tabella']) ? forzaStringa($_POST['id_cancello_tabella']) : 0;		$arrayOggetti = explode(",", $cancello);		foreach((array)$arrayOggetti as $id) {			if($id > 0) {				$tipo = mostraDatoOggetto($id, 11, 'tipologia');				if($tipo == 'bandi ed inviti') {					$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE tipologia = 'lotto' AND id_record_cig_principale = ".$id;					if(!($result = $database->connessioneConReturn($sql))) {}					$record = $database->sqlArrayAss($result);					foreach((array)$record as $l) {						if($l['id'] > 0) {							$lotti[] = $l['id'];						}					}				}			}		}		$_POST['lotti_da_eliminare'] = implode(',', $lotti);	}		private function eliminazioneLottiOrfani() {		global $database, $dati_db, $enteAdmin;				if($_POST['lotti_da_eliminare'] != '') {			$sql = "DELETE FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id IN (".forzaStringa($_POST['lotti_da_eliminare']).")";			if(!($result = $database->connessioneConReturn($sql))) {}		}	}			public function verificaErroriAnac($istanzaOggetto) {		global $database, $dati_db, $enteAdmin;				if($istanzaOggetto['id'] > 0) {			include('app/validazioniBandiAVCP.php');						$sql = "UPDATE ".$dati_db['prefisso']."oggetto_gare_atti SET __errori_anac = ".$numErrori." WHERE id = ".$istanzaOggetto['id'];			if(!($result = $database->connessioneConReturn($sql))) {}		}			}}?>
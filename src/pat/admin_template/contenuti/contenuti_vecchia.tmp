<? 

////////////////////// AZIONI DI AMMINISTRAZIONE DEI CONTENUTI ////////////////////
/*
echo "Post: <pre>";
print_r($_POST);
echo "</pre>";
*/
if (isset($_POST['contenutoSezione'.$id]) and $azione == 'edita') {

	// ho inviato richiesta di editing di un modello (solo contenuto html)
	$modelloCaricato = datoModelloTrasp($idEnteAdmin,$sezione['id']);	
	
	$contenuto = addslashes($_POST['contenutoSezione'.$id]);
	$_POST['html_generico'] = $contenuto;
	
	if (!$modelloCaricato) {
		// il paragrafo non esiste, effettuo un update
		if (aggiungiModelloTrasp($idEnteAdmin,$id,$_POST)) {
			// OPERAZIONE ANDATA A BUON FINE
			$operazione = true;
			$operazioneTesto = "Modifica del contenuto effettuata con successo.";
			
		} else {
			// ERRORI NELL'OPERAZIONE
			$operazione = false;
			$operazioneTesto = "Problemi in modifica del contenuto. Riprovare in seguito.";
			$codiceErrore = '#00 - Generico';
		}		
	} else {
		// il paragarfo esiste, devo solo effettuare un update
		if (modificaDatoModelloTrasp($modelloCaricato['id'],$contenuto,'html_generico')) {
			// OPERAZIONE ANDATA A BUON FINE
			$operazione = true;
			$operazioneTesto = "Modifica del contenuto effettuata con successo.";
			
		} else {
			// ERRORI NELL'OPERAZIONE
			$operazione = false;
			$operazioneTesto = "Problemi in modifica del contenuto. Riprovare in seguito.";
			$codiceErrore = '#00 - Generico';
		}
	}
}

?>



<script type="text/javascript">	
	// attivo la validazione inline del form
	jQuery(document).ready(function(){
		jQuery('.accordion').accordion({
			heightStyle: "content",
			collapsible: true,
			active: false
		});
		
		// pulsante di visualizzazione editor
		jQuery('.visualizzaContenuto').click(function(){
			
			// operazioni per l'apertura del campo di modifica
			var id = jQuery(this).attr('id').slice(3);
			
			alert('click: '+id);
			/*
			jQuery('#boxCont'+id).attr('display','none;');		
			jQuery('#boxForm'+id).attr('display','block;');
			*/
			jQuery('#boxCont'+id).toggle("fast");		
			jQuery('#boxForm'+id).toggle("fast");	
			CKEDITOR.replace('contenutoSezione'+id);
		});
		
		// pulsante di visualizzazione editor
		jQuery('.modificaContenuto').click(function(){
			
			// operazioni per l'apertura del campo di modifica
			var id = jQuery(this).attr('id').slice(3);
			
			alert('click: '+id);
			/*
			jQuery('#boxCont'+id).attr('display','none;');		
			jQuery('#boxForm'+id).attr('display','block;');
			*/
			jQuery('#boxCont'+id).toggle("fast");		
			jQuery('#boxForm'+id).toggle("fast");	
			CKEDITOR.replace('contenutoSezione'+id);
		});
		
		// ALERT DELLE OPERAZIONI
		<? if (isset ($operazione) and $operazione != '') { ?>
		<? if (!$operazione) { ?>
			// errore
			jQuery.alerts.dialogClass = 'alert-warning';
			jAlert('<? echo $operazioneTesto; ?>', 'Messaggio di errore', function(){
				jQuery.alerts.dialogClass = null; // reset to default
			});
		<? } else { ?>
			// successo
			jQuery.alerts.dialogClass = 'alert-success';
			jAlert('<? echo $operazioneTesto; ?>', 'Messaggio di successo', function(){
				jQuery.alerts.dialogClass = null; // reset to default
			});
		<? } ?>
		<? } ?>
		
	});
</script>

<h5 class="subtitle">Scegli il contenuto che vuoi amministrare</h5>

<div class="accordion accordion-inverse">
	<? // ciclo le sezioni
	foreach ($sezioni as $sezione) { 
		if ($sezione['id_riferimento']==18 AND $sezione['permessi_lettura']!='HM' AND $sezione['permessi_lettura']!='H') { 
			// recupero il contenuto amministrativo di presentazione
			$testoHelp = datoGuidaTrasp($sezione['id']);			
			// testo modello
			$modello = datoModelloTrasp($idEnteAdmin,$sezione['id']);		
?>
		
			<h3><a href="#"><i class="iconsweets-folder"></i> <? echo $sezione['nome']; ?></a></h3>
			<div>
				<div class="tabs-left">
					<ul class="nav nav-tabs">
						<li class="active"><a data-toggle="tab" href="#snodo"><i class="iconfa-home"></i> <? echo $sezione['nome']; ?></a></li>								
						<? 	foreach ($sezioni as $sezioneInterna) { 
								if ($sezioneInterna['id_riferimento']==$sezione['id'] AND $sezioneInterna['permessi_lettura']!='HM' AND $sezioneInterna['permessi_lettura']!='H') { 
								?>							
									<li><a data-toggle="tab" href="#sez<? echo $sezioneInterna['id']; ?>"><i class="iconfa-folder-close"></i> <? echo $sezioneInterna['nome']; ?></a></li>
							<? } 
							} ?>
					</ul>
					<div class="tab-content">
					
						<div id="snodo" class="tab-pane active">
							<div class="widgetbox box-info">
								<h4 class="widgettitle"><i class="iconfa-info-sign"></i> Guida ai contenuti <a class="close">&times;</a></h4>
								<div class="widgetcontent">
								<? 						
									if (!is_array($testoHelp)) {
										// avviso che ancora non è presente questo testo
										echo "<p><span class=\"label\"><i class=\"iconsweets-alert\"></i> Guida non presente</span></p>";
									} else {
										// pubblico il testo
										echo $testoHelp['testo_html'];
										echo "<br />";
										echo "<h5 class=\"subtitle\">Tipo di contenuti da pubblicare</h5>";
										echo "<p>".$testoHelp['tipo_contenuti']."</p>";
										echo "<br />";
										echo "<h5 class=\"subtitle\">Operazioni consigliate</h5>";
										switch($testoHelp['operazioni']) {
										
											case "sezione ospitante oggetti":
												echo "<p>Per la pagina \"<strong>".$sezione['nome']."</strong>\" non è normalmente necessario editare del contenuto libero, poichè la sezione ospita già dei contenuti di pubblicazione automatica.</p>";
											break;
											
											case "sezione snodo":
												echo "<p>Per la pagina \"<strong>".$sezione['nome']."</strong>\" è sconsigliabile editare del contenuto libero, poichè la sezione è di snodo verso gli altri contenuti.</p>";
											break;
											
											case "non editare contenuto di sezione":
											echo "<p>".$testoHelp['tipo_contenuti']."</p>";
											break;
											
											case "editare contenuto di sezione":
											echo "<p>".$testoHelp['tipo_contenuti']."</p>";
											break;
										}
									}
								?>
								</div>
							</div>

						

							<div class="widgetbox box-inverse">
								<div class="headtitle">
									<div class="btn-group">
										<button data-toggle="dropdown" class="btn dropdown-toggle"><i class="iconfa-th"></i> &nbsp; Operazioni <span class="caret"></span></button>
										<ul class="dropdown-menu">
											<li><a href="#" id="vis<? echo $sezione['id']; ?>" class="visualizzaContenuto" ><i class="iconfa-search"></i> &nbsp;Visualizza il contenuto</a></li>
											<li><a href="#" id="mod<? echo $sezione['id']; ?>" class="modificaContenuto"><i class="iconfa-edit"></i> &nbsp;Edita il contenuto</a></li>
											<li class="divider"></li>
											<li><a href="#" idcanc="0" class="confCanc"><i class="iconfa-trash"></i> &nbsp;Elimina il contenuto</a></li>
										</ul>
									</div>
									<h4 class="widgettitle">Contenuto editabile</h4>
								</div>
								<div class="widgetcontent">
									<?
									
									echo "<div id=\"boxCont".$sezione['id']."\">";									
									if (!is_array($modello)) {
										// avviso che ancora non è presente questo testo
										echo "<p><i class=\"iconsweets-alert\"></i> Nessun contenuto editabile inserito per questa pagina.</p>";
									} else {
										// pubblico il testo
										echo $modello['html_generico'];
									}
									echo "</div>";
									
									// pubblico il form editor di gestione dei contenuti
									echo "<div id=\"boxForm".$sezione['id']."\" style=\"display:none;\">";
									echo "<form id=\"formContenuti".$sezione['id']."\" method=\"post\" enctype=\"multipart/form-data\" action=\"?menu=contenuti&amp;azione=edita&amp;id=".$sezione['id']."\">";
									echo "<textarea name=\"contenutoSezione".$sezione['id']."\" id=\"contenutoSezione".$sezione['id']."\">".$modello['html_generico']."</textarea>"; 
									echo "<p class=\"stdformbutton\">";
									echo "<button class=\"btn btn-primary\">Salva il contenuto</button>";
									echo "</p>";
									echo "</form>";
									echo "</div>";
									?>		
								</div>
							</div>	
							<br /><br />
						</div>
						
						<? // ripeto il contenuto del tabs 	
						foreach ($sezioni as $sezioneInterna) { 
								if ($sezioneInterna['id_riferimento']==$sezione['id'] AND $sezioneInterna['permessi_lettura']!='HM' AND $sezioneInterna['permessi_lettura']!='H') { 
									// recupero il contenuto amministrativo di presentazione
									$testoHelpInterno = datoGuidaTrasp($sezioneInterna['id']);			
									// testo modello
									$modelloInterno = datoModelloTrasp($idEnteAdmin,$sezioneInterna['id']);	
								
								?>							

								<div id="sez<? echo $sezioneInterna['id']; ?>" class="tab-pane">
								
									<div>

										<div class="widgetbox box-info">
											<h4 class="widgettitle"><i class="iconfa-info-sign"></i> Guida ai contenuti<a class="close">&times;</a></h4>
											<div class="widgetcontent">
											<? 						
												if (!is_array($testoHelpInterno)) {
													// avviso che ancora non è presente questo testo
													echo "<p><span class=\"label\"><i class=\"iconsweets-alert\"></i> Guida non presente</span></p>";
												} else {
													// pubblico il testo
													echo $testoHelpInterno['testo_html'];
													echo "<br />";
													echo "<h5 class=\"subtitle\">Tipo di contenuti da pubblicare</h5>";
													echo "<p>".$testoHelpInterno['tipo_contenuti']."</p>";
													echo "<br />";
													echo "<h5 class=\"subtitle\">Operazioni consigliate</h5>";
													switch($testoHelpInterno['operazioni']) {
													
														case "sezione ospitante oggetti":
															echo "<p>Per la pagina \"<strong>".$sezione['nome']."</strong>\" non è normalmente necessario editare del contenuto libero, poichè la sezione ospita già dei contenuti di pubblicazione automatica.</p>";
														break;
														
														case "sezione snodo":
															echo "<p>Per la pagina \"<strong>".$sezione['nome']."</strong>\" è sconsigliabile editare del contenuto libero, poichè la sezione è di snodo verso gli altri contenuti.</p>";
														break;
														
														case "non editare contenuto di sezione":
														echo "<p>".$testoHelpInterno['tipo_contenuti']."</p>";
														break;
														
														case "editare contenuto di sezione":
														echo "<p>".$testoHelpInterno['tipo_contenuti']."</p>";
														break;
													}
												}
											?>
											</div>
										</div>
										
									</div>
										

									<div class="widgetbox box-inverse">
										<div class="headtitle">
											<div class="btn-group">
												<button data-toggle="dropdown" class="btn dropdown-toggle"><i class="iconfa-th"></i> &nbsp; Operazioni <span class="caret"></span></button>
												<ul class="dropdown-menu">
													<li><a href="#" id="vis<? echo $sezioneInterna['id']; ?>" class="visualizzaContenuto" ><i class="iconfa-search"></i> &nbsp;Visualizza il contenuto</a></li>
													<li><a href="#" id="mod<? echo $sezioneInterna['id']; ?>" class="modificaContenuto"><i class="iconfa-edit"></i> &nbsp;Edita il contenuto</a></li>
													<li class="divider"></li>
													<li><a href="#" idcanc="0" class="confCanc"><i class="iconfa-trash"></i> &nbsp;Elimina il contenuto</a></li>
												</ul>
											</div>
											<h4 class="widgettitle">Contenuto editabile</h4>
										</div>
										<div class="widgetcontent">
											
											<?
											echo "<div id=\"boxCont".$sezioneInterna['id']."\">";
											
											if (!is_array($modelloInterno)) {
												// avviso che ancora non è presente questo testo
												echo "<p><i class=\"iconsweets-alert\"></i> Nessun contenuto editabile inserito per questa pagina.</p>";
											} else {
												// pubblico il testo
												echo $modelloInterno['html_generico'];
											}
											echo "</div>";
											
											// pubblico il form editor di gestione dei contenuti
											echo "<div id=\"boxForm".$sezioneInterna['id']."\" style=\"display:none;\">";
											echo "<form id=\"formContenuti".$sezioneInterna['id']."\" method=\"post\" enctype=\"multipart/form-data\" action=\"?menu=contenuti&amp;azione=edita&amp;id=".$sezioneInterna['id']."\">";
											echo "<textarea name=\"contenutoSezione".$sezioneInterna['id']."\" id=\"contenutoSezione".$sezioneInterna['id']."\">".$modelloInterno['html_generico']."</textarea>"; 
											echo "<p class=\"stdformbutton\">";
											echo "<button class=\"btn btn-primary\">Salva il contenuto</button>";
											echo "</p>";
											echo "</form>";
											echo "</div>";
											?>		
										</div>
									</div>
									<br /><br />
								</div>								
								
								
							<? } 
						} ?>
						
					</div>
				</div>

			</div>
		<? }
	} ?>
</div>
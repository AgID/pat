<script type="text/javascript">	
	
	// attivo la validazione inline del form
	jQuery(document).ready(function(){

		// necessario per i campi file
		jQuery('.uniform-file').uniform();
		// necessario per i campi select con ricerca
		jQuery(".chzn-select").chosen({no_results_text: "Nessun risultato per",allow_single_deselect: true});		

		jQuery('label[for="file_atto"]').find('.icon-ok-circle').hide();
		
		jQuery('#tipo_incarico').change(function(){
			if(jQuery('#tipo_incarico').val() != 'incarichi dipendenti esterni'){
				jQuery('label[for="file_atto"]').find('.icon-ok-circle').hide();
			} else {
				jQuery('label[for="file_atto"]').find('.icon-ok-circle').show();
			}
		});
		
		jQuery.validator.addMethod("allegatoCheck", function(value , element) {
			if('<? echo $id; ?>' != '') {
				//modifica
				if(jQuery('#'+element.id+'azione').val() == 'nessuna') {
					return true;
				} else if(jQuery('#'+element.id+'azione').val() == 'elimina') {
					return false;
				} else if(jQuery('#'+element.id+'azione').val() == 'modifica' && !jQuery('#'+element.id).val()) {
					return false;
				} else if(jQuery('#'+element.id+'azione').val() == 'importAllegato' && !jQuery('#import-file-'+element.id).val()) {
					return false;
				} else if(jQuery('#'+element.id+'azione').val() == 'aggiungi' && !jQuery('#'+element.id).val() && !jQuery('#import-file-'+element.id).val()) {
					return false;
				} else {
					return true;
				}
			} else {
				//inserimento
				if(!jQuery('#'+element.id).val() && !jQuery('#import-file-'+element.id).val()) {
					return false;
				} else {
					return true;
				}
			}
		}, 'Inserisci il file allegato');
		
		// Devo inizializzare il campo editor col nuovo ckEditor
		var editorDesc = CKEDITOR.replace( 'note' );
		var editorEstremi = CKEDITOR.replace( 'estremi_atti' );

		jQuery("#formOggetto").validate({
			ignore: null,
			ignore: 'input[type="hidden"]',
			debug: false,
			focusInvalid: true,
			focusCleanup: false,
			errorPlacement: function(error, element) {
				if (element.parent().parent().parent().parent().parent().attr('class') == "contenitore-errore-allegato") {
					//file non inserito nel caso di import da albo
					error.appendTo( element.parent().parent().parent().parent().parent() );
				} else if (element.parent().parent().attr('class') == "input-append") {
					error.appendTo( element.parent().parent().parent().parent() );
				} else {
					error.appendTo( element.parent().parent() );
				}
			},	
			
			rules: {
				<?if(($datiUser['id_ente_admin']==35 OR ($datiUser['id_ente_admin']==142 AND $datiUser['acl']==3)) AND $aclTrasparenza[$menuSecondario]['modifica'] AND $aclTrasparenza[$menuSecondario]['creazione'] AND $_GET['azione'] != 'aggiungi') {
						echo "id_proprietario: \"required\",";
				}?>		
				nominativo: "required",
				<? // scelta ente
				if ($datiUser['permessi']==10 AND !$id) { 
					echo "id_ente: \"required\",";
				} ?>
				oggetto: "required",
				compenso: "required",
				/*
				file_atto: {
					allegatoCheck: function(element) {
						return jQuery('#tipo_incarico').val() == 'incarichi dipendenti esterni';
					}
				},
				*/
				tipo_incarico: "required"
			},
			
			messages: {
				nominativo: "Inserisci il nominativo del soggetto incaricato",
				<? // scelta ente
				if ($datiUser['permessi']==10 AND !$id) { 
					echo "id_ente: \"Devi selezionare l'ente per il quale inserire la modulistica\",";
				} ?>
				oggetto: "Inserisci l'oggetto dell'incarico",
				compenso: "Inserisci il compenso previsto, comprensivo di eventuali parti variabili",
				file_atto: "Devi inserire l'allegato contenente l'atto di conferimento",
				tipo_incarico: "Seleziona la tipologia",
				id_proprietario: "Devi selezionare l'utente proprietario"
			},
			
			highlight: function(label) {
				jQuery(label).closest('.control-group').addClass('error');
			}

		});
		
		
	});
</script>

<? if(!$box) { ?>
	<a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>" class="btn btn-rounded"> <i class="iconfa-circle-arrow-left"></i> &nbsp; Torna a elenco incarichi e consulenze</a> 
<? } ?>
<div class="widgetbox box-inverse">

	<h4 class="widgettitle">
		<? if ($id) { echo "Modifica"; } else {  echo "Aggiunta"; } ?> incarichi e consulenze
	</h4>

	<div class="widgetcontent wc1">
		<? include ('./pat/admin_template/oggetti/info_form.tmp'); ?>
		<form id="formOggetto" class="stdform" method="post" enctype="multipart/form-data" action="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=lista&amp;azionesec=<? echo $azione; ?>&amp;id=<? echo $id; ?>&amp;box=<? echo $box; ?>">
		
			<? creaFormTrasp('','sistema', '', '', '', '',''); ?>
			
			<?
			// scelta ente
			if ($datiUser['permessi']==10 AND !$id) { 
				creaFormTrasp('Ente di Appartenenza','enti', 'id_ente', '', '', '','input-xlarge',0,'', 0, 0,true); 
			} else {
				echo "<input type=\"hidden\" id=\"id_ente\" name=\"id_ente\" value=\"".$datiUser['id_ente_admin']."\">";
			}
			//import atto da albo online
			if($azione == 'importAtto' and $atto['id'] > 0) {
				echo "<input type=\"hidden\" id=\"id_atto_albo\" name=\"id_atto_albo\" value=\"".$atto['id']."\" />";
			}
			?>
			
			<? creaFormTrasp('Soggetto incaricato','testo', 'nominativo', '', $istanzaOggetto['nominativo'], '','input-xxlarge',0,'', 0, 0,true); ?>
			
			<? creaFormTrasp('Oggetto incarico o consulenza','testo', 'oggetto', '', $istanzaOggetto['oggetto'], '','input-xxlarge',0,'', 0, 0,true); ?>
			
			<? creaFormTrasp('Tipo di incarico','selezione', 'tipo_incarico', 'incarichi dipendenti interni,incarichi dipendenti esterni', $istanzaOggetto['tipo_incarico'], 'Incarichi retribuiti e non retribuiti dei propri dipendenti,incarichi retribuiti e non retribuiti affidati a soggetti esterni','input-xxlarge',0,'Seleziona il tipo', 0, 0,true); ?>
			
			<? creaFormTrasp('Incarico amm. di vertice/dirigenziale (esclude pubbl. in Consulenti)','casella', 'dirigente', '1', $istanzaOggetto['dirigente'], '',''); ?>
			
			<? creaFormTrasp('Struttura organizzativa responsabile','struttura', 'struttura', '', $istanzaOggetto['struttura'], '','input-xxlarge'); ?>
			
			<? creaFormTrasp('Data di inizio incarico','data', 'inizio_incarico', '', $istanzaOggetto['inizio_incarico'], '',''); ?>		

			<? creaFormTrasp('Data di fine incarico','data', 'fine_incarico', '', $istanzaOggetto['fine_incarico'], '',''); ?>				
			
			<? creaFormTrasp('Compenso','testo', 'compenso', '', $istanzaOggetto['compenso'], '','input-small',0,'', 0, 0,true); ?>
			
			<? creaFormTrasp('Compenso erogato','testo', 'compenso_erogato', '', $istanzaOggetto['compenso_erogato'], '','input-small',0,'', 0, 0,false); ?>
			
			<? creaFormTrasp('Componenti variabili del compenso','areatesto', 'compenso_variabile', '', $istanzaOggetto['compenso_variabile'], '','input-xxlarge'); ?>

			<? creaFormTrasp('Estremi atto di conferimento','html', 'estremi_atti', '', $istanzaOggetto['estremi_atti']); ?>
			
			<? creaFormTrasp('Note (incarichi, cariche, altre attivitï¿½)','html', 'note', '', $istanzaOggetto['note'], '',''); ?>
			
			<? // file allegati 
			
			creaFormTrasp('Atto di conferimento','file', 'file_atto', '', $istanzaOggetto['file_atto'], '','',0,'', 0, 0,true); 
			creaFormTrasp('Curriculum del soggetto incaricato','file', 'cv_soggetto', '', $istanzaOggetto['cv_soggetto'], '',''); 
			creaFormTrasp('Progetto selezionato','file', 'progetto', '', $istanzaOggetto['progetto'], '',''); 
			creaFormTrasp('Attestazione della verifica sul conflitto d\'interessi','file', 'verifica_conflitto', '', $istanzaOggetto['verifica_conflitto'], '',''); 
			
			?>
				
			<p class="stdformbutton">
				<?
				if($statoWfPrecedente['id']) {
					?>
					<button onclick="jQuery('#stato_workflow_da_assegnare').val('<? echo $statoWfPrecedente['id']; ?>');inviaForm=true;" class="btn btn-primary">Torna allo stato precedente (<? echo $statoWfPrecedente['nome']; ?>)</button>
					<?
				}
				?>
				<button onclick="inviaForm=true;" class="btn btn-primary">Salva dati</button>
				<?
				if($statoWfSuccessivo['id']) {
					?>
					<button onclick="jQuery('#stato_workflow_da_assegnare').val('<? echo $statoWfSuccessivo['id']; ?>');inviaForm=true;" class="btn btn-primary">Vai allo stato successivo (<? echo $statoWfSuccessivo['nome']; ?>)</button>
					<?
				}
				?>
			</p>
		</form>
	</div>
</div>
<? if(!$box) { ?>
	<a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>" class="btn btn-rounded"> <i class="iconfa-circle-arrow-left"></i> &nbsp; Torna a elenco incarichi e consulenze</a> 
<? } ?>
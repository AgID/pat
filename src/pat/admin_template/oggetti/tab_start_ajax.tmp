<script type="text/javascript">
	var tabellaDinamica;
    jQuery(document).ready(function(){
	
        // dinamicizzo la tabella 
        tabellaDinamica = jQuery('#dyntable').dataTable({
            "sPaginationType": "full_numbers",
            "aaSortingFixed": [[<? echo count($campiVisualizzati); ?>,'desc']],
			"aoColumnDefs": [
				{ "bSortable": false, "aTargets": [ 0, <? echo count($campiVisualizzati)+1; ?> ] }
			],
			"oLanguage": {
                "sUrl": "pat/js/jquery.dataTables.italiano.txt"
            },
			"bProcessing": true,
			"bServerSide": true,
			"sAjaxSource": "ajax_paginazionetable_new.php?id_ogg=<? echo $idOggetto; ?>&menu=<? echo $_GET['menu']; ?>&menusec=<? echo $_GET['menusec']; ?>",
			"bDeferRender": true,
            "fnDrawCallback": function(oSettings) {
                jQuery.uniform.update();

				// RIPETO INIZIALIZZAZIONE DEI TOOLTIP
				if(jQuery('table .intTooltip').length > 0) {
					jQuery('table a[data-rel]').each(function() {
						jQuery(this).attr('rel', jQuery(this).data('rel'));
					});
					jQuery('table .intTooltip').tooltip({selector: "a[rel=tooltip]"});
				}
				
				////////////////////////////////////////////// RIPETO FUNZIONI DI CANCELLAZIONE
				if(jQuery('.confCanc').length > 0) {
					jQuery('.confCanc').click(function(){
					
						var idCancello = jQuery(this).attr('idcanc');
						//alert('Attributo da cancellare: '+idCancello);
						// verifico se usare l'id o le selezioni
						if (idCancello==0) {
							// cerco tutte le caselle selezionate
							var numCanc = 0;
							var parentTable = jQuery('#dyntable');	
							var ch = jQuery('input[type=checkbox]', tabellaDinamica.fnGetNodes());
							var idCancello = '';
							ch.each(function(){
								if ( jQuery(this).attr('checked')) {
									// casella selezionata
									if (idCancello != '') {
											idCancello = idCancello+',';
									}
									idCancello = idCancello+jQuery(this).attr('value');
									numCanc++;
								}
							});							
						} else {	
							var numCanc = 1;
						}
						
						if (numCanc==0) {
							jQuery.alerts.dialogClass = 'alert-inverse';
							jAlert('Nessun elemento selezionato per la cancellazione.', 'Messaggio di sistema', function(){
								jQuery.alerts.dialogClass = null; // reset to default
							});
						} else {
							testo = '';
							<?
							if($idOggetto == 46) {
								?>
								testo = '<br /><br /><strong>ATTENZIONE: verranno pubblicati tutti gli eventuali elementi attualmente presenti in uno degli stati intermedi dei workflow in eliminazione.</strong>';
								<?
							}
							?>
							jConfirm('Sei sicuro di voler proseguire con la cancellazione ? Proseguendo '+numCanc+' elementi verranno eliminati. '+testo, 'Richiesta di conferma', function(r) {
								if (r) {
									// proseguo con la cancellazione, invio il form con i valori
									jQuery('#id_cancello_tabella').attr('value',idCancello);
									//alert('Questi sono gli ID che cancello: '+jQuery('#id_cancello_tabella').attr('value'));
									jQuery('#formCancella').submit();
								}
							});
						}
					});
				}	
				
				
            }
        });
		// rimuovo il contenuto quando cambio modale di review
		jQuery('body').on('hidden', '.modal', function () {
			jQuery(this).removeData('modal');
		});
		// includo gestione delle selezioni
		<? include_once("./pat/admin_template/operazioni_selezione.tmp"); ?>
		
		// includo gestione delle notifiche delle operazioni
		<? include_once("./pat/admin_template/operazioni_alert.tmp"); ?>
		
    });

</script>

<? // includo gestione delle cancellazioni
include_once("./pat/admin_template/operazioni_cancella.tmp"); ?>

<!--# inizio modale review -->	
<div aria-hidden="false" aria-labelledby="modaleLabelReview" role="dialog" class="modal hide fade width60" id="modaleReview" style="margin-left:-26%;">
	<div class="modal-header">
		<button aria-hidden="true" data-dismiss="modal" class="close" type="button">&times;</button>
		<h3 id="modaleLabelStorico"><span style="color:#757575;" class="iconfa-search"></span> Dettagli</h3>
	</div>
	<div class="modal-body">
			
	</div>
	
	<div class="modal-footer">
		<button data-dismiss="modal" class="btn">Chiudi</button>
	</div>
</div>			
<!--# fine modale review -->

<? if($azione != 'selectIstanze' and $azione != 'selectIstanzeAmm') { ?>
	<div class="headtitle">
		<div class="btn-group">
			<button data-toggle="dropdown" class="btn dropdown-toggle"><i class="iconfa-th"></i> &nbsp; Operazioni <span class="caret"></span></button>
			<ul class="dropdown-menu">
				<? if (!$aclTrasparenza[$menuSecondario]['creazione'] AND !$aclTrasparenza[$menuSecondario]['cancellazione'] AND !$aclTrasparenza[$menuSecondario]['avanzate']) { ?>
				<li><a><i class="iconfa-info-sign"></i> &nbsp;Nessuna operazione disponibile</a></li>
				<? } ?>
				<?
				if ($aclTrasparenza[$menuSecondario]['creazione']) {
					if(moduloAttivo('bandigara') and $idOggetto == 11) {
						?>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi&amp;tipo=bando"><i class="iconfa-plus-sign"></i> &nbsp;Nuovo Bando di gara</a></li>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi&amp;tipo=lotto"><i class="iconfa-plus-sign"></i> &nbsp;Nuovo Lotto</a></li>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi&amp;tipo=esito"><i class="iconfa-plus-sign"></i> &nbsp;Nuovo Esito di gara</a></li>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi&amp;tipo=avviso"><i class="iconfa-plus-sign"></i> &nbsp;Nuovo Avviso</a></li>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi&amp;tipo=affidamento"><i class="iconfa-plus-sign"></i> &nbsp;Nuovo Affidamento</a></li>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi&amp;tipo=delibera"><i class="iconfa-plus-sign"></i> &nbsp;Nuova Determina Art. 57 Comma 6 Dlgs. 163/2006</a></li>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi&amp;tipo=liquidazione"><i class="iconfa-plus-sign"></i> &nbsp;Nuova Liquidazione</a></li>
						<?
					} else {
						?>
						<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=aggiungi"><i class="iconfa-plus-sign"></i> &nbsp;<? echo $funzioneSottoMenu['azioneNuova']; ?></a></li>
						<?
					}
				}
				?>
				<? if ($aclTrasparenza[$menuSecondario]['cancellazione']) { ?>
				<li class="divider"></li>
				<li><a href="#" idcanc="0" class="confCanc"><i class="icon-trash"></i> &nbsp;<? echo $funzioneSottoMenu['azioneCancella']; ?></a></li>
				<? } ?>
				<? if ($aclTrasparenza[$menuSecondario]['avanzate']) { ?>
				<li class="divider"></li>
				<li><a href="?menu=<? echo $menu; ?>&amp;menusec=<? echo $menuSecondario; ?>&amp;azione=importa"><i class="iconsweets-excel"></i> &nbsp;Importa dati da excel</a></li>
				<li><a href="Javascript:window.open('export_oggetti.php?classe_doc=documento&id=<? echo $idOggetto; ?>&id_ente=<? echo $idEnteAdmin; ?>');void(0);"><i class="iconsweets-excel"></i> &nbsp;Esporta dati in excel</a></li>
					<? if ($oggettiTrasparenza[$idOggetto]['openDataAmministrazione']) { ?>
						<li><a href="Javascript:window.open('export_open_data_csv.php?visualizzaURL=0&id_criterio=136&id_oggetto=<? echo $idOggetto; ?>&id_ente=<? echo $idEnteAdmin; ?>');void(0);"><i class="iconsweets-incoming"></i> &nbsp;Esporta in open data</a></li>
					<? } ?>
				<? } ?>
				<? if ($oggOgg->idCategoria) { ?>
				<li class="divider"></li>
				<li><a href="#"><i class="iconfa-lock"></i> &nbsp;<? echo $funzioneSottoMenu['azioneSposta']; ?></a></li>
				<? } ?>
			</ul>
		</div>
		<h4 class="widgettitle"><? echo $funzioneSottoMenu['titTabella']; ?></h4>
	</div>
<? } else { ?>
	<div class="headtitle">
		<div class="btn-group">
			<a href="javascript:inviaSelezionati();" class="btn btn-rounded"> <i class="iconfa-ok"></i> &nbsp; Seleziona e salva</a>
		</div>
		<h4 class="widgettitle"><? echo $funzioneSottoMenu['titTabella']; ?></h4>
	</div>
<? } ?>

<table id="dyntable" class="table table-bordered">
	<colgroup>
		<col class="con0" style="align: center; width: 58px" />
		<? if ($datiUser['permessi']==10) {
			echo "<col class=\"con0\" />";
		} 
		$numConto = 0;
		foreach($campiVisualizzati as $campo) {
			if($numConto & 1) {
				echo "<col class=\"con0\" />";
			} else {
				echo "<col class=\"con1\" />";
			}
			$numConto++;
		} ?>
		<col class="con1" style="align: center; width: 90px;" />
	</colgroup>
	<thead>
		<tr>
			<th class="head0 nosort"><input type="checkbox" class="checkall" /></th>
			<? if ($datiUser['permessi']==10) {
				echo "<th class=\"head0\">Ente</th>";
			} 
			$numConto = 0;
			foreach($campiVisualizzati as $campo) {
				$etichette = explode("}",$campo['etichetta']); 
				$campo['etichetta'] = $etichette[0];	
				if($numConto & 1) {				
					echo "<th class=\"head0\">";
				} else {
					echo "<th class=\"head1\">";
				}
				if ($campo['etichetta'] != '') {
					echo $campo['etichetta'];
				} else {
					echo "&nbsp;";
				}
				echo "</th>";
				$numConto++;
			} ?>
			<th class="head0 nosort"></th>
		</tr>
	</thead>
	<tbody>


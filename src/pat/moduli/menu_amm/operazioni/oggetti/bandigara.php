<?phpinclude_once 'pat/moduli/menu_amm/operazioni/oggetti/OperazioneDefault.php';class bandigara extends OperazioneDefault {		public function __construct() { }		public function preInsert($arrayParametri = array()) {		global $enteAdmin;				//questa condizione con il relativo codice interno deve stare prima delle chiamate a correggiValori e caricaValoriProceduraRelativa		if(moduloAttivo('bandigara')) {			$this->preparaValoriCigMultipli();		}		$this->correggiValori();		$this->caricaValoriProceduraRelativa();	}		public function preUpdate($arrayParametri = array()) {		global $enteAdmin;		$this->correggiValori();		$this->caricaValoriProceduraRelativa();	}		public function preDelete() {		if(moduloAttivo('bandigara')) {			$this->verificaEliminazioneLotti();		}	}		public function postInsert($arrayParametri = array()) {		if(moduloAttivo('bandigara')) {			$this->inserisciRecordAltriCig();		}	}		public function postDelete($arrayParametri = array()) {		if(moduloAttivo('bandigara')) {			$this->eliminazioneLottiOrfani();		}	}		private function inserisciRecordAtto() {		global $database, $dati_db, $enteAdmin;				$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." ORDER BY id DESC LIMIT 1";		if(!($result = $database->connessioneConReturn($sql))) {}		$record = $database->sqlArray($result);				$atto = caricaDocumentoEAlbo('atti', $_POST['id_atto_albo']);				$sql = "INSERT INTO ".$dati_db['prefisso']."etrasp_atti_ealbo (id_ente, id_ente_albo, id_atto_albo, id_oggetto, id_documento, ultima_modifica) 				VALUES (".$enteAdmin['id'].", ".$enteAdmin['id_ente_albo'].", ".$_POST['id_atto_albo'].", 11, ".$record['id'].", ".$atto['ultima_modifica'].")";		if(!($result = $database->connessioneConReturn($sql))) {}				collegaAttoEtrasparenza($_POST['id_atto_albo'], 1, $enteAdmin);	}		private function eliminaRecordAtto() {		global $database, $dati_db, $enteAdmin;				$cancello = isset($_POST['id_cancello_tabella']) ? $_POST['id_cancello_tabella'] : 0;		$arrayOggetti = explode(",", $cancello);		$arrayOggettiAlbo = array();		$numeroOggetti = count($arrayOggetti)-1;		$condizione = 'id_documento='.$arrayOggetti[0];		$arrayOggettiAlbo[] = getIdRecordAtto($enteAdmin['id'], $enteAdmin['id_ente_albo'], $arrayOggetti[0], 11);		for ($i=1;$i<$numeroOggetti+1;$i++) {			if ($arrayOggetti[$i] != '') {				$condizione .= ' OR id_documento='.$arrayOggetti[$i];				$arrayOggettiAlbo[] = getIdRecordAtto($enteAdmin['id'], $enteAdmin['id_ente_albo'], $arrayOggetti[$i], 11);			}		}		$sql = "DELETE FROM ".$dati_db['prefisso']."etrasp_atti_ealbo WHERE id_ente = ".$enteAdmin['id']." AND id_ente_albo = ".$enteAdmin['id_ente_albo']." AND id_oggetto = 11 AND (".$condizione.")";		if(!($result = $database->connessioneConReturn($sql))) {}				foreach((array) $arrayOggettiAlbo as $id) {			collegaAttoEtrasparenza($id, 0, $enteAdmin);		}	}		private function preparaValoriCigMultipli() {		//metodo richiamato se modulo 'bandigara' è attivo		if($_POST['tipologia'] == 'bandi ed inviti') {					$_POST['altri_cig'] = array();			for($i=1; $i<=$_POST['numRigheCig']; $i++) {				if(trim($_POST['cig'.$i]) != '') {					$this->correggiValori($i);					$_POST['altri_cig'][] = array (						'cig' => $_POST['cig'.$i],						'valore_base_asta' => $_POST['valore_base_asta'.$i]					);				}			}						if(count($_POST['altri_cig']) > 1) {				//il bando principale non avrà cig, nè valori. Il valore importo a base asta sarà la somma di tutti i singoli valori				$_POST['cig'] = '';				$_POST['valore_base_asta'] = '';			} else if(count($_POST['altri_cig']) == 1) {				//inserimento bando con cig singolo				$_POST['cig'] = $_POST['altri_cig'][0]['cig'];				$_POST['valore_base_asta'] = $_POST['altri_cig'][0]['valore_base_asta'];			}		} else if($_POST['tipologia'] == 'lotto') {			$_POST['oggetto'] = mostraDatoOggetto($_POST['id_record_cig_principale'], 11, 'oggetto');		}	}		private function inserisciRecordAltriCig() {		global $database, $dati_db, $enteAdmin, $oggOgg, $idCategoriaPasso;				if(count($_POST['altri_cig']) > 1) {			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$record = $database->sqlArray($result);						$aggiorno = false;			foreach((array)$_POST['altri_cig'] as $recordCig) {				$arrayLotto = array();				$arrayLotto['id_lingua'] = '0';				$arrayLotto['id_proprietari_admin'] = '-1';				$arrayLotto['tipo_proprietari_admin'] = 'tutti';				$arrayLotto['permessi_admin'] = 'N/A';				$arrayLotto['id_proprietari_lettura'] = '-1';				$arrayLotto['tipo_proprietari_lettura'] = 'tutti';				$arrayLotto['permessi_lettura'] = 'N/A';				$arrayLotto['id_proprietario'] = $_POST['id_proprietario'];				$arrayLotto['id_ente'] = $enteAdmin['id'];								$arrayLotto['oggetto'] = $_POST['oggetto'];				$arrayLotto['tipologia'] = 'lotto';				$arrayLotto['cig'] = $recordCig['cig'];				$arrayLotto['valore_base_asta'] = $recordCig['valore_base_asta'];				$arrayLotto['id_record_cig_principale'] = $record['id'];				$oggOgg->aggiungiOggetto($idCategoriaPasso, $arrayLotto);				$aggiorno = true;			}			if($aggiorno) {				//NOTA: non permettere la trasformazione da lotto singolo a multilotto				//ho più lotti per la stessa procedura				$sql = "UPDATE ".$dati_db['prefisso']."oggetto_gare_atti SET id_record_cig_principale = ".$record['id']." WHERE id = ".$record['id'];				if(!($result = $database->connessioneConReturn($sql))) {}			}		}	}		private function correggiValori($suffisso = '') {		if(trim($_POST['valore_base_asta'.$suffisso]) != '') {			$_POST['valore_base_asta'.$suffisso] = str_replace(',','.',str_replace('.','',trim($_POST['valore_base_asta'.$suffisso])));		}		if(trim($_POST['valore_importo_aggiudicazione'.$suffisso]) != '') {			$_POST['valore_importo_aggiudicazione'.$suffisso] = str_replace(',','.',str_replace('.','',trim($_POST['valore_importo_aggiudicazione'.$suffisso])));		}		if(trim($_POST['importo_liquidato'.$suffisso]) != '') {			$_POST['importo_liquidato'.$suffisso] = str_replace(',','.',str_replace('.','',trim($_POST['importo_liquidato'.$suffisso])));		}	}		private function caricaValoriProceduraRelativa() {		global $database, $dati_db, $enteAdmin;				if($_POST['bando_collegato']){			$id_bando_collegato = $_POST['bando_collegato'];			$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id_ente = ".$enteAdmin['id']." AND id=".$id_bando_collegato." ORDER BY id DESC LIMIT 1";			if(!($result = $database->connessioneConReturn($sql))) {}			$record = $database->sqlArray($result);			if($record['cig']){				$_POST['cig'] = $record['cig'];				if($_POST['tipologia'] == 'somme liquidate' and moduloAttivo('bandigara')) {					$_POST['oggetto'] = $record['oggetto'];				} 			}		}			}		private function verificaEliminazioneLotti() {		global $database, $dati_db, $enteAdmin;				$lotti = array();		$cancello = isset($_POST['id_cancello_tabella']) ? $_POST['id_cancello_tabella'] : 0;		$arrayOggetti = explode(",", $cancello);		foreach((array)$arrayOggetti as $id) {			if($id > 0) {				$tipo = mostraDatoOggetto($id, 11, 'tipologia');				if($tipo == 'bandi ed inviti') {					$sql = "SELECT * FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE tipologia = 'lotto' AND id_record_cig_principale = ".$id;					if(!($result = $database->connessioneConReturn($sql))) {}					$record = $database->sqlArrayAss($result);					foreach((array)$record as $l) {						if($l['id'] > 0) {							$lotti[] = $l['id'];						}					}				}			}		}		$_POST['lotti_da_eliminare'] = implode(',', $lotti);	}		private function eliminazioneLottiOrfani() {		global $database, $dati_db, $enteAdmin;				if($_POST['lotti_da_eliminare'] != '') {			$sql = "DELETE FROM ".$dati_db['prefisso']."oggetto_gare_atti WHERE id IN (".$_POST['lotti_da_eliminare'].")";			if(!($result = $database->connessioneConReturn($sql))) {}		}	}}?>